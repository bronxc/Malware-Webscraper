import sys
import os
import WebscraperUtilities
from androidApp import androidApp


def main():
    
    toolKeywords = WebscraperUtilities.getKeywords(sys.argv[1])
    global appList
    appList = []

    for keyword in toolKeywords:
        pageNumber = 1
        requestString = "http://filehippo.com/search?q=" + keyword + "&p=" + str(pageNumber)
        bs = WebscraperUtilities.getBeautifulSoupWebsiteSource(requestString)
        for i in range(2,10):
            addAllApps(bs)
            pageNumber = pageNumber + 1
            requestString = "http://filehippo.com/search?q=" + keyword + "&p=" + str(i)
            bs = WebscraperUtilities.getBeautifulSoupWebsiteSource(requestString)

        removeEmptyApps()

        WebscraperUtilities.writeJsonFile(sys.argv[1], os.path.basename(__file__), appList)

def addAllApps(bs):
    appDivs = bs.find_all("div", {"class" : "program-entry"})
    for div in appDivs:
        try:
            aTag = div.find("div", {"class" : "program-entry-header"}).find("a", href=True)
            appLink = "http://filehippo.com" + aTag['href']
            appName = div.find("span", {"class" : "program-title-text"}).find("h2").get_text()
            print(appName)
            currentApp = androidApp(appName, appLink)
            addAppInfo(currentApp)
            appList.append(currentApp)
        except:
            pass

def addAppInfo(app):
    bs = WebscraperUtilities.getBeautifulSoupWebsiteSource(app.link)
    authorATag = bs.find("span", {"class" : "program-header-author"}).find("a", title=True)
    appAuthor = authorATag['title']
    appDescription = bs.find("div", {"id" : "fh-program-description-text-column"}).get_text()
    app.setAuthor(appAuthor)
    app.setDescription(appDescription)
    appHistoryBs = WebscraperUtilities.getBeautifulSoupWebsiteSource(app.link + "history")
    addAppVerisons(app, appHistoryBs)

def addAppVerisons(app, bs):
    page = 1
    while(True):
        try:
            versionLis = bs.find("ol", {"id" : "program-history-list"}).find_all("li")
            for li in versionLis:
                versionATag = li.find("a", href=True)
                app.addVersion(versionATag.get_text(), "http://filehippo.com/" + versionATag['href'])
            page = page + 1
            bs = WebscraperUtilities.getBeautifulSoupWebsiteSource(app.link + "history/" + str(page))
        except:
            return

def removeEmptyApps():
    for app in appList:
        if(len(app.appVersions) == 0):
            appList.remove(app)

if __name__ == '__main__':
    main()