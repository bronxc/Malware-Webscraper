import requests
import sys
import os
import json
from bs4 import BeautifulSoup
from selenium import webdriver
from androidApp import androidApp

def main():
    #set the path to the chromedriver
    driverPath = os.getcwd() + "\chromedriver.exe"
    global driver
    driver = webdriver.Chrome(driverPath)
    #get the keyword file from keywords folder based on command line argument passed in
    keywordFile = os.getcwd() + "/keywords/" + sys.argv[1]
    toolKeywords = []
    #for each of the keywords in the keyword file add them to toolKeywords list
    with open(keywordFile, 'r') as file:
        for line in file.readlines():
            toolKeywords.append(line.strip('\n'))
    #list that will be used to store all of the app objects created
    androidAppList = []

    #for all the keywords in the keywords list, it will go through the apkpure.com website to
    #scrape all the information from every app it can find that contains one of the keywords
    for keyword in toolKeywords:
        #request string for a query on apkpure.com searching with a keyword
        requestString = "https://apkpure.com/search?q=" + keyword
        driver.get(requestString)

        clickLoadMoreButton()

        #get source code from driver then create a beautiful soup object to
        #parse through and search the html
        page = driver.page_source
        soup = BeautifulSoup(page,"html.parser")
        #the html of the div block that contains all the apps inside of it
        appContainer = soup.find("div", {"id":"search-res"})

        #list that will contain each of the a tags for all the apps on the page
        appATags = []
        #list containing all the dt tags for each of the apps shown on the page
        appsInContainer = appContainer.findAll("dt")
        #go through all the apps in the list and add each app's a tag to the appATags list
        for app in appsInContainer:
            appATags.append(app.find("a", href=True, title=True))

        for aTag in appATags:
            #create androidApp object
            try:
                #get the link to the app's page
                appLink = "https://apkpure.com" + aTag['href']
                #create android app object
                currentAndroidApp = androidApp(aTag['title'], appLink)
                #get html code of current app's page
                appPage = getBeautifulSoupWebsiteSource(appLink)
                #add author and description information to the androidApp object
                setAuthorAndDescription(currentAndroidApp,appPage)
                #get all the a tags that contain all the versions for that app
                allAppVersions = appPage.find("div", {"id":"faq_box"}).findAll("a", {"class": " down"}, href=True, title=True)
            #if an exception is raised program will simply pass by this app and not add it
            except:
                pass
            #add each app version to the app version list in the object
            addAppVersions(allAppVersions,currentAndroidApp)
            androidAppList.append(currentAndroidApp)
    
    #create json file and write contents of each app found to that file
    with open('apps.json', 'w') as file:
        file.write("[\n")
        file.write(json.dumps(androidAppList[0].__dict__))
        for i in range(1, len(androidAppList)):
            file.write(",\n")
            file.write(json.dumps(androidAppList[i].__dict__))
        file.write("\n]")

    #sends signal to shutdown selenium chrome browser
    driver.quit()

#function that will click on the load more button on the page
#until there are no more apps to load
def clickLoadMoreButton():
    try:
        while(True):
            loadMoreButton = driver.find_element_by_class_name("loadmore")
            driver.execute_script("arguments[0].click();", loadMoreButton)
    except:
        return

#create request object to specified link then creates and returns
#a beautiful soup object from the websites content to parse through html
def getBeautifulSoupWebsiteSource(link):
    req = requests.get(link)
    webpageContent = req.content
    return BeautifulSoup(webpageContent, "html.parser")

#function that takes a reference to an app object and sets the author
#and description of that app object to info found on the app's page
def setAuthorAndDescription(app,appPage):
    appAuthor = appPage.find("ul", {"class":"version-ul"}).find("li").find("a").get_text()
    app.setAuthor(appAuthor)
    appDescription = appPage.find("div", {"class":"description"}).get_text()
    app.setDescription(appDescription)

#function that takes a reference to an app object and a list of
#the app's versions and adds each version to the app object
def addAppVersions(appVersionList,app):
    for appVersion in appVersionList:
        directDownloadLink = "https://apkpure.com" + appVersion['href']
        app.addVersion(appVersion['title'],directDownloadLink)

if __name__ == '__main__':
    main()