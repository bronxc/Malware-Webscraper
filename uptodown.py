import requests
import sys
import os
import json
import time
from bs4 import BeautifulSoup
from androidApp import androidApp
import WebscraperUtilities

def main():
    
    toolKeywords = WebscraperUtilities.getKeywords(sys.argv[1])
    global androidAppList
    androidAppList = []

    #for all the keywords in the anti-forensics keywords list, it will go through the uptodown.com
    #website to scrape all the information from every app it can find
    for keyword in toolKeywords:
        #initialize pageNumber to start at first page of website
        pageNumber = 1
        #request string for a query on uptodown.com searching with a keyword and the given page number
        requestString = "http://en.uptodown.com/android/as?search=" + keyword + "&pag=" + str(pageNumber) + "&num=16"
        #get beatiful soup object from request string
        appPageSource = WebscraperUtilities.getBeautifulSoupWebsiteSource(requestString)
        #loop through each page until it reaches a blank page
        while(appPageSource.getText() != ""):
            #add each app on the page to the android app list
            addAllApps(appPageSource)
            pageNumber = pageNumber + 1
            requestString = "http://en.uptodown.com/android/as?search=" + keyword + "&pag=" + str(pageNumber) + "&num=16"
            appPageSource = WebscraperUtilities.getBeautifulSoupWebsiteSource(requestString)
    
    WebscraperUtilities.writeJsonFile(sys.argv[1], os.path.basename(__file__), androidAppList)

def addAllApps(pageSource):
    appLinksList = []
    addAppLinks(pageSource, appLinksList)
    createAndAppendApps(appLinksList)

def addAppLinks(pageSource, linkList):
    aTags = pageSource.find_all("a", href=True)
    for aTag in aTags:
        linkList.append(aTag['href'])

def createAndAppendApps(appLinks):
    for link in appLinks:
        try:
            pageSource = WebscraperUtilities.getBeautifulSoupWebsiteSource(link)
            olderVersionSource = WebscraperUtilities.getBeautifulSoupWebsiteSource(link + "/old")
            addAppInfo(pageSource, olderVersionSource, link)
        except Exception as e:
            print(e)

def getAllVersions(app, appLink, olderVersionSource):
    olderVersionSource = WebscraperUtilities.getBeautifulSoupWebsiteSource(appLink + "/old")
    versionDivs = olderVersionSource.find("div", {"class" : "row-gallery"}).find_all("div", {"class" : "item"})
    for version in versionDivs:
        versionNumber = version.find("span", {"class" : "app_card_version"}).getText()
        versionATag = version.find("a" , href=True)
        versionLink = versionATag['href']
        app.addVersion(versionNumber, versionLink)
        
def addAppInfo(pageSource, olderVersionSource, appLink):
    appName = pageSource.find("h1", {"class" : "name"}).getText()
    appAuthor = pageSource.find("div", {"class" : "author"}).find("span").getText()
    try:
        appDescription = pageSource.find("div", {"class" : "more-info-content"}).find("p").getText()
    except:
        appDescription = "N/A"
    currentApp = androidApp(appName, appLink)
    currentApp.setAuthor(appAuthor)
    currentApp.setDescription(appDescription)
    getAllVersions(currentApp, appLink, olderVersionSource)
    androidAppList.append(currentApp)

if __name__ == '__main__':
    main()